name: Test_on_FreeBSD
on:
    push:
        branches:
            - master
            - develop

env:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8
jobs:
    fly-test:
        runs-on: macos-10.15
        steps:
            - uses: actions/checkout@v2
            - name: Setup FreeBSD
              uses: vmactions/freebsd-vm@v0.1.5
              with:
                  usesh: true
                  mem: 4096
                  prepare: |
                      pkg update
                      pkg install -y autoconf autoconf-archive automake autotools gcc sqlite3 python36 py36-sqlite3 python37 py37-sqlite3 python38 py38-sqlite3 python39 py39-sqlite3 python310 py310-sqlite3 lsof
                      python3.6 -m ensurepip
                      python3.6 -m pip install --upgrade pip
                      python3.7 -m ensurepip
                      python3.7 -m pip install --upgrade pip
                      python3.8 -m ensurepip
                      python3.8 -m pip install --upgrade pip
                      python3.9 -m ensurepip
                      python3.9 -m pip install --upgrade pip
                      python3.10 -m ensurepip
                      python3.10 -m pip install --upgrade pip
                  run: |
                      autoreconf --force --install
                      ./configure
                      cat config.h
                      make
                      make install
                      echo "nameserver 8.8.8.8" | tee /etc/resolv.conf
                      python3.6 -m pip install -r ./requirements.txt
                      python3.6 setup.py build
                      python3.7 -m pip install -r ./requirements.txt
                      python3.7 setup.py build
                      python3.8 -m pip install -r ./requirements.txt
                      python3.8 setup.py build
                      python3.9 -m pip install -r ./requirements.txt
                      python3.9 setup.py build
                      python3.10 -m pip install -r ./requirements.txt
                      python3.10 setup.py build
                      cp build/lib.*/fly/_fly_server.cpython* fly/
                      ls -l fly/ | grep _fly_server.cpython*
                      openssl req \
                      -subj '/CN=localhsot' \
                      -x509 -nodes -days 365 -newkey rsa:2048 \
                      -keyout tests/fly_test.key \
                      -out tests/fly_test.crt
                      export _PATH_PYTHON=$(which python3.10)
                      ln -sf $_PATH_PYTHON $(dirname $_PATH_PYTHON)/python3
                      echo $_PATH_PYTHON
                      which python3
                      if test -f "fly/_fly_server.cpython-310-*"; then \
                            python3 -m pytest tests -xv; \
                      fi
                      export _PATH_PYTHON=$(which python3.9)
                      ln -sf $_PATH_PYTHON $(dirname $_PATH_PYTHON)/python3
                      echo $_PATH_PYTHON
                      which python3
                      if test -f "fly/_fly_server.cpython-39-*"; then \
                            python3 -m pytest tests -xv; \
                      fi
                      export _PATH_PYTHON=$(which python3.8)
                      ln -sf $_PATH_PYTHON $(dirname $_PATH_PYTHON)/python3
                      echo $_PATH_PYTHON
                      which python3
                      if test -f "fly/_fly_server.cpython-38-*"; then \
                            python3 -m pytest tests -xv; \
                      fi
                      export _PATH_PYTHON=$(which python3.7)
                      ln -sf $_PATH_PYTHON $(dirname $_PATH_PYTHON)/python3
                      echo $_PATH_PYTHON
                      which python3
                      if test -f "fly/_fly_server.cpython-37-*"; then \
                            python3 -m pytest tests -xv; \
                      fi
                      export _PATH_PYTHON=$(which python3.6)
                      ln -sf $_PATH_PYTHON $(dirname $_PATH_PYTHON)/python3
                      echo $_PATH_PYTHON
                      which python3
                      if test -f "fly/_fly_server.cpython-36-*"; then \
                            python3 -m pytest tests -xv; \
                      fi
